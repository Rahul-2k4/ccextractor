name: Timing Drift Test (226-230)

# Only runs on this branch - safe to push without affecting upstream
on:
  push:
    branches:
      - fix/ci-timing-tests-clean
      - 'feature/*timing*'
      - 'ci/*timing*'
  workflow_dispatch:

env:
  SAMPLE_HASH: c4dd893cb9d67be50f88bdbd2368111e16b9d1887741d66932ff2732969d9478
  VCPKG_DEFAULT_TRIPLET: x64-windows-static
  VCPKG_COMMIT: ab2977be50c702126336e5088f4836060733c899

jobs:
  # ============================================
  # LINUX BUILD AND TEST
  # ============================================
  linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libgpac-dev \
            libtesseract-dev \
            libleptonica-dev \
            pkg-config

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Linux binary
        run: |
          cd linux
          ./autogen.sh
          ./configure
          make -j$(nproc)
          
      - name: Display Linux version
        run: ./linux/ccextractor --version

      - name: Run Test 226
        run: |
          mkdir -p test_results
          if [ -f "test_samples/test226_sample.ts" ]; then
            ./linux/ccextractor test_samples/test226_sample.ts --startcreditstext "CCextractor Start crdit Testing" -o test_results/test226.srt
            echo "=== First timestamp ==="
            grep -m1 '^[0-9]' test_results/test226.srt | head -1
          fi
        continue-on-error: true

      - name: Run Tests 227-230
        run: |
          if [ -f "test_samples/test226_sample.ts" ]; then
            ./linux/ccextractor test_samples/test226_sample.ts --startcreditsnotbefore 1 --startcreditstext "CCextractor Start crdit Testing" -o test_results/test227.srt
            ./linux/ccextractor test_samples/test226_sample.ts --startcreditsnotafter 2 --startcreditstext "CCextractor Start crdit Testing" -o test_results/test228.srt
            ./linux/ccextractor test_samples/test226_sample.ts --startcreditsforatleast 1 --startcreditstext "CCextractor Start crdit Testing" -o test_results/test229.srt
            ./linux/ccextractor test_samples/test226_sample.ts --startcreditsforatmost 2 --startcreditstext "CCextractor Start crdit Testing" -o test_results/test230.srt
          fi
        continue-on-error: true

      - name: Upload Linux results
        uses: actions/upload-artifact@v6
        with:
          name: linux-test-results
          path: |
            test_results/
            *.log

  # ============================================
  # WINDOWS BUILD AND TEST
  # ============================================
  windows:
    runs-on: windows-2022
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v2.0.0
        with:
          msbuild-architecture: x64

      - name: Install gpac
        run: choco install gpac --version 2.4.0 --no-progress

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        id: runvcpkg
        with:
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: 'windows/vcpkg.json'

      - name: Cache vcpkg installed packages
        id: vcpkg-installed-cache
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/vcpkg/installed
          key: vcpkg-installed-${{ runner.os }}-${{ env.VCPKG_COMMIT }}-${{ hashFiles('windows/vcpkg.json') }}
          restore-keys: |
            vcpkg-installed-${{ runner.os }}-${{ env.VCPKG_COMMIT }}-

      - name: Install vcpkg dependencies
        if: steps.vcpkg-installed-cache.outputs.cache-hit != 'true'
        run: ${{ github.workspace }}/vcpkg/vcpkg.exe install --x-install-root ${{ github.workspace }}/vcpkg/installed/
        working-directory: windows

      - name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build artifacts
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/windows/x86_64-pc-windows-msvc
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/rust/**/*.rs') }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Win 10 SDK
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build Windows binary
        env:
          LIBCLANG_PATH: "C:\\Program Files\\LLVM\\lib"
          LLVM_CONFIG_PATH: "C:\\Program Files\\LLVM\\bin\\llvm-config"
          BINDGEN_EXTRA_CLANG_ARGS: -fmsc-version=0
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        run: msbuild ccextractor.sln /p:Configuration=Release-Full /p:Platform=x64
        working-directory: ./windows

      - name: Display Windows version
        run: ./ccextractorwinfull.exe --version
        working-directory: ./windows/x64/Release-Full

      - name: Run Test 226
        shell: cmd
        run: |
          if exist test_samples\test226_sample.ts (
            mkdir test_results 2>nul
            .\windows\x64\Release-Full\ccextractorwinfull.exe test_samples\test226_sample.ts --startcreditstext "CCextractor Start crdit Testing" -o test_results\test226.srt
            type test_results\test226.srt | findstr /r "^[0-9][0-9]:"
          )
        continue-on-error: true

      - name: Run Tests 227-230
        shell: cmd
        run: |
          if exist test_samples\test226_sample.ts (
            .\windows\x64\Release-Full\ccextractorwinfull.exe test_samples\test226_sample.ts --startcreditsnotbefore 1 --startcreditstext "CCextractor Start crdit Testing" -o test_results\test227.srt
            .\windows\x64\Release-Full\ccextractorwinfull.exe test_samples\test226_sample.ts --startcreditsnotafter 2 --startcreditstext "CCextractor Start crdit Testing" -o test_results\test228.srt
            .\windows\x64\Release-Full\ccextractorwinfull.exe test_samples\test226_sample.ts --startcreditsforatleast 1 --startcreditstext "CCextractor Start crdit Testing" -o test_results\test229.srt
            .\windows\x64\Release-Full\ccextractorwinfull.exe test_samples\test226_sample.ts --startcreditsforatmost 2 --startcreditstext "CCextractor Start crdit Testing" -o test_results\test230.srt
          )
        continue-on-error: true

      - name: Upload Windows results
        uses: actions/upload-artifact@v6
        with:
          name: windows-test-results
          path: |
            test_results/
            *.log

  # ============================================
  # SUMMARY REPORT
  # ============================================
  summary:
    needs: [linux, windows]
    runs-on: ubuntu-22.04
    steps:
      - name: Download Linux results
        uses: actions/download-artifact@v6
        with:
          name: linux-test-results
          path: linux-results
        continue-on-error: true

      - name: Download Windows results
        uses: actions/download-artifact@v6
        with:
          name: windows-test-results
          path: windows-results
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Timing Drift Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Linux Results" >> $GITHUB_STEP_SUMMARY
          if [ -d "linux-results/test_results" ]; then
            for f in linux-results/test_results/*.srt; do
              echo "- $(basename $f): $(grep -m1 '^[0-9]' $f 2>/dev/null | head -1)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Windows Results" >> $GITHUB_STEP_SUMMARY
          if [ -d "windows-results/test_results" ]; then
            for f in windows-results/test_results/*.srt; do
              echo "- $(basename $f): $(grep -m1 '^[0-9]' $f 2>/dev/null | head -1)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No results available" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Expected: Start credits at 00:00:04,456" >> $GITHUB_STEP_SUMMARY
